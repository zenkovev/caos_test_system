# 10-1: Fuse: Mergefs

## Условие задачи

Реализуйте файловую систему, доступную только для чтения, которая строит объединение нескольких
каталогов в одно дерево, по аналогии с [UnionFS](https://ru.wikipedia.org/wiki/UnionFS),
по следующим правилам:
- если встречаются два файла с одинаковым именем, то правильным считается тот, у которого более
поздняя дата модификации;
- если встречаются два каталога с одинаковым именем, то нужно создавать объединение их содержимого.

Внутри файловой системы могут быть только регулярные файлы с правами не выше 0444 и подкаталоги
с правами не выше 0555.

Программа для реализации файловой системы должна поддерживать стандартный набор опций FUSE и опцию
для указания списка каталогов для объединения --src КАТАЛОГ\_1:КАТАЛОГ\_2:...:КАТАЛОГ\_N.

Используйте библиотеку FUSE версии 3.0 и выше. На сервер нужно отправить только исходный файл,
который будет скомпилирован и слинкован с нужными опциями.

## Комментарий к тестам

В случае реализации достаточно сложных файловых систем громоздкой работой является
подсчёт числа хард-ссылок на обычный файл или директорию, в основном на директорию.
При этом, так как файловые системы в задачах не реализуют удаление файлов или создание хард-ссылок,
этот подсчёт не имеет особого смысла.
Поэтому гарантируется, что это не проверяется тестами.
Можно также посмотреть это
[обсуждение](https://stackoverflow.com/questions/62264562/what-to-set-for-st-nlink-as-attribute-when-implementing-fuse).

Уровни `run.sh` и `run_hard.sh` отличаются только каталогами,
на основе которых создаётся файловая система.
Помимо файлов, использующихся для запуска тестов, созданы вспомогательные файлы
для понимания работы тестов, подробнее указано ниже.

Компиляция файла с программой производится с помощью `cmake`,
для этого в директории с задачей есть `CMakeLists.txt`.
Отчёт о сборке выводится в файл `tmp_files/cmake_and_make_output.txt`.
Если программа скомпилирована успешно, то она находится как `tmp_files/mergefs`.

Создаваемая при запуске тестов файловая система монтируется в директорию `tmp_files/mnt`.
Размонтирование выполняется в скрипте `clear.sh`. В большинстве случаев,
в частности при корректном решении, размонтирование работает корректно,
но в случае возникновения проблем следует размонтировать вручную,
а затем повторно запустить скрипт `clear.sh`.

## Краткое описание работы тестов

При тестировании компилируется программа.
Для этого с помощью `CMakeLists.txt` производится сборка в `tmp_files/build`,
после чего собранная программа выносится как `tmp_files/mergefs`.
Если программа не собрана, то запуски программы не производятся.

Затем производится монтирование файловой системы в директорию `tmp_files/mnt`
в результате запуска программы на основе заготовленных данных.

Данные частично создаются в процессе запуска самих тестов.
Все исходные данные находятся:
- для `run.sh`: в директории `test_files/dirs_test_1`
- для `run_hard.sh`: в директории `test_files/dirs_test_2`

Каталоги из условия создаются в процессе тестирования скриптом `scripts/dirs_create.sh`
из соответствующей директории, создаются в `tmp_files/dirs_for_union`.
В `scripts/dirs_description.txt` есть краткое описание того, что создаётся.
То, какие каталоги передаются программе, можно посмотреть в `run.sh` и `run_hard.sh`.

Также есть поддиректория `expected_file_system`, которая демонстрирует, как должна
выглядеть файловая система в `tmp_files/mnt`, с той разницей, что там лежат обычные файлы.

Используется проверка вывода в следующих случаях:
- поток ошибок при монтировании файловой системы -
должен быть пустым - не очень содержательная проверка;
- вывод утилиты `ls` для рекурсивного запуска от точки монтирования -
проверяет корректность дерева файловой системы;
- содержимое файлов полученной файловой системы, выведенное подряд, файлы отсортированы
для однозначности - проверяет корректность операций открытия и чтения файла.
